#+STARTUP: nohideblocks

* Readme
Place your private configuration here! Remember, you do not need to run 'doom
sync' after modifying this file!

Here are some additional functions/macros that could help you configure Doom:
- ~load!~ for loading external *.el files relative to this one
- ~use-package!~ for configuring packages
- ~after!~ for running code after a package has loaded
- ~add-load-path!~ for adding directories to the `load-path', relative to
  this file. Emacs searches the `load-path' when you load packages with
  `require' or `use-package'.
- ~map!~ for binding new keys

* Variables
Local:
#+begin_src emacs-lisp
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-
#+end_src

Global:
#+begin_src emacs-lisp
(setq
  ;; Some functionality uses this to identify you,
  ;; e.g. GPG configuration, email clients, file templates and snippets.
  user-full-name "sad"
  user-mail-address "d3v1ant@mail.ru"

  ;; doom-theme 'doom-opera
  org-directory "~/org/"
  fill-column 80 ;; 70, must be a default value to work
  display-fill-column-indicator-column 80
  better-jumper-context 'buffer
  default-input-method "russian-computer"
  ;; A depth of 1 means check all the subdirectories of DIRECTORY.
  projectile-project-search-path '(("~/git" . 1))
  ;; make emacs always use its own browser for opening URL links
  browse-url-browser-function 'eww-browse-url)

#+end_src

[[id:310c1ee3-2e64-4a4a-b494-53b90b813d7e][Fonts]]:
#+begin_src emacs-lisp
(setq
 ;; firacode nerd font
 doom-font (font-spec :family "JetBrainsMono Nerd Font" :size 17) ;; :weight 'light
 ;; for text modes, like Zen, Org or Markdown.
 doom-variable-pitch-font (font-spec :family "daddytimemono nerd font" :size 17)
 doom-unicode-font (font-spec :family "Symbola")
 doom-big-font (font-spec :family "JetBrainsMono Nerd Font" :size 24))

  ;; 'pmsl nerd' - get all installed nerd fonts
  ;; doom-font (font-spec :family "saucecodepro nerd font" :size 17)
  ;; copy of source code pro but with better composite glyphs
  ;; doom-font (font-spec :family "hasklug nerd font" :size 17)
  ;; doom-font (font-spec :family "hack nerd font" :size 17)
#+end_src

Hlissner:
#+begin_src emacs-lisp
(setq
  ;; Line numbers are pretty slow all around. The performance boost of
  ;; disabling them outweighs the utility of always keeping them on.
  display-line-numbers-type nil

  ;; IMO, modern editors have trained a bad habit into us all: a burning need for
  ;; completion all the time -- as we type, as we breathe, as we pray to the
  ;; ancient ones -- but how often do you *really* need that information? I say
  ;; rarely. So opt for manual completion
  company-idle-delay nil
  )
#+end_src
* Keybindings
Learn how to properly define your custom keybindings you can in [[https://www.youtube.com/watch?v=QRmKpqDP5yE&list=PLhXZp00uXBk4np17N39WvB80zgxlZfVwj&index=28][this vid]]

#+begin_src emacs-lisp
(map! :leader :desc "M-x" "x" 'execute-extended-command)
;; diff-hl bindings
(map! :leader :desc "Git show hunk" "gv" 'diff-hl-show-hunk)
(map! :leader :desc "Git show hunk" "g{" 'diff-hl-show-hunk-previous)
(map! :leader :desc "Git show hunk" "g}" 'diff-hl-show-hunk-next)
(map! :leader :desc "Ace window" "ww" 'ace-window)
(map! :leader :desc "Xwidget" "ox" 'xwidget-webkit-browse-url)
(map! :leader :desc "Web Wowser" "oe" 'eww)

(map! :leader :desc "Edmacro insert key" "i k" 'sad-wrapped-eik)
(map! :leader :desc "Find file other window" "f o" 'find-file-other-window)
(map! :leader :desc "Theme other" "t o" 'sad-theme-randomize)
(map! :leader :desc "Switch to true last buffer" "b o" 'sad-true-switch-last-buffer)

(define-key global-map (kbd "C-,") 'embark-act)

;; Digraph
(map! :leader
      (:prefix-map ("d" . "digraph")
       :desc "Insert COUNT digraphs" "i" 'evil-insert-digraph
       :desc "Shows a list of all available digraphs" "s" 'evil-ex-show-digraphs
       :desc "Read two keys from keyboard forming a digraph" "r" 'evil-read-digraph-char))

(setq! evil-want-C-u-delete nil)
#+end_src
* Startup and Global modes
#+begin_src emacs-lisp
;; Prevents some cases of Emacs flickering
(add-to-list 'default-frame-alist '(inhibit-double-buffering . t))

(global-subword-mode)
(global-display-fill-column-indicator-mode)
(global-auto-revert-mode)
#+end_src

* Development
** LSP
#+begin_src emacs-lisp
;; Disable invasive lsp-mode features
;; https://emacs-lsp.github.io/lsp-mode/tutorials/how-to-turn-off/
(setq
  lsp-ui-sideline-enable nil   ; not anymore useful than flycheck
  lsp-ui-doc-enable nil        ; slow and redundant with K
  lsp-enable-symbol-highlighting t) ; why not

(setq lsp-vetur-format-default-formatter-html '"prettier")
#+end_src
** Golang
#+begin_src emacs-lisp
;; https://github.com/golang/tools/blob/master/gopls/doc/settings.md
(after! go-mode
  (setq gofmt-args '("-s")))

(after! lsp-mode
  (lsp-register-custom-settings
   '(("gopls.completeUnimported" t t)
     ;; ("gopls.vulncheck" "imports")
     ;; https://github.com/golang/tools/blob/master/gopls/doc/inlayHints.md
     ;; https://github.com/golang/tools/blob/master/gopls/doc/settings.md#inlayhint
     ;; ("gopls.hints" ...)
     ("gopls.staticcheck" t t))))
#+end_src
** JS
#+begin_src emacs-lisp
;; does this even work? and is it even needed?
(set-docsets! 'js2-mode "JavaScript")

(after! js2-mode
  (set-company-backend! 'js2-mode 'company-tide 'company-yasnippet))
#+end_src
** Elm
#+begin_src emacs-lisp
;; (add-to-list 'company-backends 'elm-company)
;; (add-hook 'elm-mode-hook 'elm-format-on-save-mode)
#+end_src
** Shell
#+begin_src emacs-lisp
(after! sh-script
  (set-company-backend! 'sh-mode
    '(company-shell :with company-yasnippet)))
#+end_src
** Magit & forge
Magit:
#+begin_src emacs-lisp
(setq
 ;; magit-save-repository-buffers nil
 ;; Don't restore the wconf after quitting magit, it's jarring
 magit-inhibit-save-previous-winconf t
 transient-values '((magit-rebase "--autosquash" "--autostash")
                    (magit-pull "--rebase" "--autostash"))
 ;; Enable Gravatars REVIEW does it even works?
 ;; This will enable gravatars when viewing commits.
 ;; The service used by default is Libravatar.
 magit-revision-show-gravatars '("^Author:     " . "^Commit:     ")
 )
#+end_src

Forge:
#+begin_src emacs-lisp
;; my attempts to make forge work with custom gitlab url...
;; did not suffice elisp knowledge to do that (not all forge functions were working..)
(after! forge
  (push '("gitlab.medpoint24.ru" "gitlab.medpoint24.ru/api/v4"
          "gitlab.medpoint24.ru" forge-gitlab-repository) forge-alist))
#+end_src

* Evil
#+begin_src emacs-lisp
;; Focus new window after splitting
(setq evil-split-window-below t
      evil-vsplit-window-right t)
#+end_src

* Org
#+begin_src emacs-lisp
(add-hook 'org-mode-hook 'auto-fill-mode)
;; (add-hook! 'org-mode-hook (company-mode -1))
(add-hook! 'org-capture-mode-hook (company-mode -1))

(add-hook 'org-mode-hook
          (lambda () (add-hook 'after-save-hook #'org-babel-tangle
                          :append :local)))

;; didn't work out for me cuz https://orgmode.org/manual/Custom-time-format.html
;; (setq org-time-stamp-custom-formats '("<%a %d-%m-%Y>" . "<%a %d-%m-%Y %H:%M>"))
;; (setq org-display-custom-times t)

;; TODO: make those active only in org-mode
(after! org
  (map! :leader
        :desc "Shrink" "mbS" 'org-table-shrink
        :desc "Expand" "mbE" 'org-table-expand
        :desc "Toggle width" "mbts" 'org-table-toggle-column-width)

  (setq
   org-src-window-setup 'current-window
   ;; Sort the footnote definitions by reference sequence.
   org-footnote-auto-adjust 'sort
   ;; show files like TOC on startup
   org-startup-folded 'content
   org-hide-block-startup t
   org-startup-shrink-all-tables t
   ;; org-ellipsis " ▾ "
   org-hide-emphasis-markers t)

  ;; org capture templates redefining
  (setq org-capture-templates
        (append
         '(
           ("t" "Tea entry" entry
            (file +org-capture-project-notes-file)
            "%[~/git/tea/templates/newEntry]"
            :jump-to-captured t
            :immediate-finish t
            :clock-in t
            :clock-keep t
            :empty-lines 1)
           ("n" "Notes file settings prepend" plain
            (file +org-capture-project-notes-file)
            "%[~/git/tea/templates/notesFileSettings]"
            :prepend t
            :immediate-finish t
            :empty-lines-after 1)
           ;; To insert template at point, in current file call 'spc-X' with
           ;; 'spc u 0' prefix
           ("i" "Info file settings prepend (call from a directory with info file!)" plain
            (file "./info.org")
            "%[~/git/tea/templates/infoFileSettings]"
            :prepend t
            :immediate-finish t
            :empty-lines-after 1)
           ("p" "Project-local todo" checkitem
            (file+headline +org-capture-project-todo-file "List of todos")
            "" :prepend t)
           ("T" "Personal todo" entry
            (file+headline +org-capture-todo-file "Todo")
            "* [ ] %?\n%i" :prepend t)
           ("j" "Journal" entry
            (file+olp+datetree +org-capture-journal-file)
            "* %U %?\n%i\n%a" :prepend t))

         org-capture-templates)))

;; org-mode agenda options
;; TODO: how to do it with evil embrace?
;; now after typing 'C-c C-,' u will will get a new option to chose from
(after! org (add-to-list 'org-structure-template-alist
             '("el" . "src emacs-lisp\n")))

#+end_src

* Doom dashboard
#+begin_src emacs-lisp
;; (setq fancy-splash-image (concat doom-private-dir "splash.png"))
;; Hide the menu for as minimalistic a startup screen as possible.
(remove-hook '+doom-dashboard-functions #'doom-dashboard-widget-shortmenu)

(setq +doom-dashboard-functions
      '(doom-dashboard-widget-banner doom-dashboard-widget-loaded))
#+end_src
* Mu4e
#+begin_src emacs-lisp
(after! mu4e
  (setq
   ;; avoid mail syncing issues when using mbsync
   mu4e-change-filenames-when-moving t
   mu4e-update-interval (* 10 60)
   mu4e-attachment-dir "~/Downloads"
   ;; target just one account for updating
   ;; mu4e-get-mail-command "mbsync <account>"

   mu4e-compose-dont-reply-to-self t
   sendmail-program (executable-find "msmtp")
   send-mail-function #'smtpmail-send-it
   ;; always pick current context for sending
   message-sendmail-f-is-evil t
   message-sendmail-extra-arguments '("--read-envelope-from")
   message-send-mail-function #'message-send-mail-with-sendmail)

  (set-email-account! "d3v1ant@mail.ru"
                     '((user-full-name        . "A.L.")
                       (smtpmail-smtp-user    . "d3v1ant@mail.ru")
                       ;; text in the end of composed mail
                       ;; (mu4e-compose-signature . "- sad\nnewline")
                       (mu4e-drafts-folder    . "/mailru/drafts")
                       (mu4e-sent-folder      . "/mailru/sent")
                       (mu4e-refile-folder    . "/mailru/inbox")
                       (mu4e-trash-folder     . "/mailru/trash")))

  (setq mu4e-maildir-shortcuts
           '((:maildir "/mailru/inbox"  :key ?i)
             (:maildir "/mailru/sent"   :key ?s)
             (:maildir "/mailru/trash"  :key ?t)
             (:maildir "/mailru/drafts" :key ?d)
             (:maildir "/mailru/spam"   :key ?a))))
#+end_src

* Telega
#+begin_src emacs-lisp
(map! :leader "o c" 'telega)
(setq telega-server-libs-prefix "/usr") ;; cuz aur package installs there
(map! :after telega :leader
      :prefix ("z" . "telegram")
      "a" #'telega-account-switch
      "b" #'telega-switch-buffer
      "c" #'telega-chat-with
      "e" #'telega-edit-file-switch-buffer
      "i" #'telega-switch-important-chat
      "f" #'telega-buffer-file-send
      "s" #'telega-saved-messages
      "t" #'telega
      "u" #'telega-switch-unread-chat
      "w" #'telega-browse-url)

(after! telega
  (telega-notifications-mode)
  (telega-mode-line-mode)
  (global-telega-squash-message-mode)
  ;; FIXME: kbds shadowed by evil
  (telega-image-mode) ;; n/p next prev img in chat
  (auto-fill-mode)

  (require 'telega-dired-dwim)

  ;; eval-buffer: Cannot open load file: No such file or directory, dashboard
  ;; (require 'telega-dashboard)
  ;; (add-to-list 'dashboard-items '(telega-chats . 5))

  (require 'telega-url-shorten)
  (global-telega-url-shorten-mode)

  ;; company-mode setup might look like:
  (setq
   telega-completing-read-function #'completing-read
   telega-emoji-company-backend 'telega-company-emoji
   telega-notifications-timeout 3600) ;; crutch basically


  ;; (setq telega-url-shorten-use-images t)
  ;; (add-to-list 'telega-browse-url-alist
  ;;              '("https?://\\(www\\.\\)?youtube.com/watch" . my-watch-in-mpv))
  ;; (add-to-list 'telega-browse-url-alist
  ;;              '("https?://youtu.be/" . my-watch-in-mpv))

  (add-hook 'telega-chat-mode-hook 'my-telega-chat-mode)

  ;; play youtube videos using mpv player
  (defun my-watch-in-mpv (url)
    (async-shell-command (format "mpv -v %S" url)))

  (defun my-telega-chat-mode ()
    (define-key telega-msg-button-map (kbd "SPC") nil)
    (setq truncate-lines nil)
    (set (make-local-variable 'company-backends)
         (append (list telega-emoji-company-backend
                       'telega-company-username
                       'telega-company-hashtag)
                 (when (telega-chat-bot-p telega-chatbuf--chat)
                   '(telega-company-botcmd))))
    (company-mode 1)))

#+end_src
* Emms
#+begin_src emacs-lisp
(after! emms
  (add-to-list 'emms-player-list 'emms-player-mpd)
  (add-to-list 'emms-info-functions 'emms-info-mpd)
  (setq!
   emms-source-file-default-directory "~/Music"
   emms-player-mpd-music-directory "~/Music"
   emms-source-playlist-default-format 'm3u
   emms-playlist-mode-center-when-go t
   emms-show-format "♪ %s"
   ;; emms-player-mpd-server-port "6600"
   emms-browser-default-browse-type 'info-album
   ;; new settings
   ;; covers
   emms-browser-covers #'emms-browser-cache-thumbnail-async
   emms-browser-thumbnail-small-size 32
   emms-browser-thumbnail-medium-size 64))

;; notifications
;; (require 'emms-dbus)
;; (emms-dbus-enable)


;; Once you've done the above, run the 'M-x emms-cache-set-from-mpd-all'
;; command to fill the Emms cache with the contents of your MusicPD
;; database. The music in your MusicPD database should then be accessible
;; via the Emms browser.

(map! :leader
      (:prefix ("l" . "listen")

       ;; Playback
       :desc "Current playlist buffer" "c" #'emms ;; NOTE: this thing!
       :desc "Browser / open close" "b" #'emms-smart-browse
       :desc "Play cur. playlist" "SPC" #'emms-start ;; TODO: needed?
       :desc "Pause" "x" #'emms-pause
       :desc "Stop" "X" #'emms-stop
       :desc "Next" "n" #'emms-next
       :desc "Previous" "p" #'emms-previous
       :desc "Shuffle" "S" #'emms-shuffle
       ;; :desc "Loop track (toggle)" "L" #'emms-toggle-repeat-track
       :desc "Bury emms buffers" "q" #'emms-browser-bury-buffer

       ;; Daemon / db bindings
       :desc "Start daemon" "s" #'+emms/mpd-start-music-daemon
       :desc "Restart daemon" "r" #'+emms/mpd-restart-music-daemon
       :desc "Kill daemon" "k" #'+emms/mpd-kill-music-daemon
       ;; call this manually for the newly added tracks to show up in emms
       :desc "Update db" "u" #'+emms/mpc-update-database ;; gets called on 'start'
       :desc "Update all + cache" "R" #'emms-player-mpd-update-all-reset-cache

       ;; Playlists
       (:prefix ("P" . "Playlist")
        :desc "Loop playlist (toggle)" "L" #'emms-toggle-repeat-playlist
        :desc "Shuffle (toggle)" "S" #'emms-toggle-random-playlist
        :desc "Edit playlist buffers" "l" #'emms-metaplaylist-mode-go)

       ;; Play ...
       (:prefix ("l" . "Play")
        :desc "dired" "d" #'emms-play-dired
        ;; NOTE: mainly using this since it just adds tracks from dir
        ;; (not recursively) to the playlist
        :desc "directory" "D" #'emms-play-directory
        ;; emms-play-directory-tree ;; source for multiple directory trees
        :desc "files matching regex" "f" #'emms-play-find
        :desc "file" "F" #'emms-play-file
        :desc "url (ie for streaming)" "u" #'emms-play-url
        ;; Playlists
        :desc "playlist" "p" #'emms-play-playlist
        :desc "playlist file" "P" #'emms-play-playlist-file
        :desc "playlist dir" "z" #'emms-play-playlist-directory
        :desc "playlist dir tree" "x" #'emms-play-playlist-directory-tree)))
#+end_src

* IRC [[https://github.com/emacs-circe/circe/wiki/Configuration][#configuration docs]]
#+BEGIN_SRC emacs-lisp
(map! :leader :desc "IRC" "oi" '=irc)

;; if you omit =:host=, ~SERVER~ will be used instead.
(after! circe
  (setq circe-default-part-message "(⌣_⌣”)"
        circe-default-quit-message "o/")

  ;; view 'circe-network-defaults' var to view predefined networks
  (setq circe-network-options
    `(("Libera Chat"
       :nick "earthian"
       :sasl-username ,(+pass-get-user "irc/libera.chat")
       :sasl-password (lambda (&rest _) (+pass-get-secret "irc/libera.chat")))
       ;; :channels ("#emacs" "#systemcrafters"))
      ("OFTC"
       :nick "earthian"
       :sasl-username ,(+pass-get-user "irc/libera.chat")
       :sasl-password (lambda (&rest _) (+pass-get-secret "irc/libera.chat"))))))
       ;; :channels ("#emacs" "#systemcrafters")))))

  ;; in case circe will start supporting DCC
  ;; (set-irc-server! "irc.undernet.org"
  ;;   `(;; :tls t
  ;;     :port 6667
  ;;     :nick "seme4eg"
  ;;     :channels ("#ebooks" "#Bookz")
  ;;     ))
  ;; (set-irc-server! "irc.irchighway.net"
  ;;   `(:port 6669
  ;;     :nick "seme4eg"
  ;;     :channels ("#ebooks")
  ;;     ))

;; TODO: write a function to upload image to 0x0 from a clipboard
;; (use-package! 0x0)
#+END_SRC

* Ewal
#+begin_src emacs-lisp
(use-package! ewal
  :init (setq ewal-use-built-in-always-p nil
              ewal-use-built-in-on-failure-p t
              ewal-built-in-palette "sexy-material"
              ewal-shade-percent-difference 10)
  :config (progn
            (load-theme 'ewal-doom-one t) ;; ewal-doom-vibrant-theme
            (enable-theme 'ewal-doom-one)
            (ewal-evil-cursors-get-colors :apply t)))
#+end_src
* GPTel [[https://github.com/karthink/gptel][#gh]]
#+begin_src elisp
(defun e/read-openai-key ()
  (with-temp-buffer
    (insert-file-contents "~/key.txt")
    (string-trim (buffer-string))))

(use-package! gptel
  :config
  (map! :leader "e" 'gptel)
  (setq! gptel-model "gpt-3.5-turbo"
         gptel-playback t
         gptel-default-mode 'org-mode
         gptel-api-key #'e/read-openai-key))
#+end_src

* WAIT Elcord [[https://github.com/Mstrodl/elcord][#gh]] [[https://github.com/Mstrodl/elcord/issues/84][#issue]]
#+begin_src elisp
;; (use-package! elcord
;;   :config
;;   (elcord-mode))

;; (require 'elcord)
;; (elcord-mode)
#+end_src

* Other settings
#+begin_src emacs-lisp
(add-hook 'markdown-mode-hook 'auto-fill-mode)
;; (add-hook 'doom-after-init-modules-hook #'doom-load-session) ;; slows down

;; (setq +lookup-open-url-fn #'+lookup-xwidget-webkit-open-url-fn
(setq +lookup-open-url-fn #'eww
      ;; title / url / custom func
      eww-auto-rename-buffer 'title)

(after! dash-docs
  ;; +lookup-xwidget-webkit-open-url-fn
  (setq dash-docs-browser-func #'eww))
#+end_src

A useful macro (sometimes) for timing the execution of things. From
[[https://stackoverflow.com/questions/23622296/emacs-timing-execution-of-function-calls-in-emacs-lisp][StackOverflow]].

#+begin_src emacs-lisp
(defmacro zz/measure-time (&rest body)
  "Measure the time it takes to evaluate BODY."
  `(let ((time (current-time)))
     ,@body
     (float-time (time-since time))))
#+end_src

* Custom f-s & advices
#+begin_src emacs-lisp
(defun sad-eww-other-window (orig-func &rest args)
  "Open eww web wowser in other window passing URL to origial 'eww' command'"
  (other-window 1)
  (apply orig-func args)
  (+popup/raise (selected-window)))

(advice-add 'eww :around #'sad-eww-other-window)

(defun sad-wrapped-eik ()
  "Call 'edmacro-insert-key' and wrap it's output in ~~ so those kbds look
better in org mode. Does nothing if was called on the beginning of a line"
  (interactive)
  (let ((opoint (point)))
    (unless (bolp)
      (insert "~")
      (call-interactively 'edmacro-insert-key)
      (backward-char)
      (insert "~"))))

(defun sad-theme-randomize ()
  "Loads random theme from the list of available custom themes.
Made this function only cuz im too often too lazy to make a choice."
  (interactive)
  (load-theme
   (nth (random (length (custom-available-themes))) (custom-available-themes)) t))

(defun advice--center-buffer (orig-fun &rest args)
  "Center butter."
  (evil-scroll-line-to-center (line-number-at-pos)))

(advice-add 'evil-ex-search :after #'advice--center-buffer)
(advice-add 'Info-next-reference :after #'advice--center-buffer)
(advice-add 'Info-prev-reference :after #'advice--center-buffer)

(defun sad-true-switch-last-buffer ()
  "Switch to REAL last open buffer (including buffers starting with *)."
  (interactive)
  (let ((previous-place (car (window-prev-buffers))))
    (when previous-place
      (switch-to-buffer (car previous-place))
      (goto-char (car (last previous-place))))))
#+end_src
